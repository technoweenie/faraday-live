version: "3.7"
services:
  mkcert:
    build:
      context: .
      args:
        host: faraday-live.localhost
    volumes:
      - certca:/root/.local/share/mkcert/
      - certdata:/certs

  server:
    build: ./server
    depends_on:
      - mkcert # need certca and certdata volumes filled
    networks:
      net:
        aliases:
          - faraday-live.localhost
    volumes:
      - certca:/root/.local/share/mkcert/:ro
      - certdata:/certs:ro
      - ./server/run.sh:/app/run.sh

  tests:
    build: ./tests
    depends_on:
      - server
    networks:
      - net
    environment:
      - HTTP_HOST=faraday-live.localhost
      - FARADAY_ADAPTER=${TEST_ADAPTER:-}
      - FARADAY_METHOD=${TEST_METHOD:-}
      - SERVER_PROTOCOL=${TEST_PROTO:-}
    volumes:
      - certca:/root/.local/share/mkcert/:ro
      - certdata:/certs:ro
      - ./tests/spec:/app/spec
      - ./tests/.rspec:/app/.rspec
      - ./tests/run.sh:/app/run.sh

volumes:
  certca:
  certdata:

networks:
  net:
